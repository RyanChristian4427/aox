# declare directory, so we can build by running 'jam' in this directory
SubDir TOP imapd ;

# pull in the directories we need to build the programs named at the bottom:
# - lib

SubInclude TOP lib ;
SubInclude TOP codecs ;

# - our own subdirectories, with a -I pointing here
HDRS += [ FDirName $(TOP) imapd ] ;
SubInclude TOP imapd handlers ;
SubInclude TOP imapd auth ;
SubInclude TOP imapd db ;

# declare our own directory again, for the benefit of the Build rules below

SubDir TOP imapd ;

# a rule to build the address-testing file, and maybe others later?

rule Struct
{
    Depends $(<) : $(>) ;
    Clean clean : $(<) ;
    SEARCH on $(>) = $(SEARCH_SOURCE) ;
    MakeLocate $(<) : $(LOCATE_SOURCE) ;
}

actions Struct
{
    sed -e 's/##.*//' -e 's/[\\"]/\\&/g' < $(>) | \
	grep . | \
	sed -e 's/^/{ "/' -e 's/	/", "/g' -e 's/$/" },/'> $(<)
}

# build the struct file for address testing

Struct addresses.inc : addresses.test ;
Struct datefields.inc : datefields.test ;

# build the .o files in this directory

Build imapdmain : imapd.cpp ;
Build imap : imap.cpp command.cpp cccp.cpp set.cpp mailbox.cpp 
	query.cpp address.cpp parser.cpp date.cpp header.cpp ;

Build logdmain : logd.cpp ;
Build logd : logserver.cpp ;

Build server : connection.cpp listener.cpp loop.cpp endpoint.cpp log.cpp 
    configuration.cpp die.cpp table.cpp cache.cpp ;

Build runtestsmain : runtests.cpp ;

# the programs. these need to be last. magic. all Program calls need
# to be after all Build calls, since the Build puts object files into
# the sets used by Build.

Program imapd : imap imapdmain server lib ;
LINKLIBS on imapd = -lz ;

Program logd : logd logdmain server lib ;

Program runtests : imap logd server lib runtestsmain ;
LINKLIBS on runtests = -lz ;
